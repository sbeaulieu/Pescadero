---
title: "TempStats_Using_Chemical_Data_Times"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
  word_document: default
---
This notebook uses the custom function TempStats, in the custom library PescStats (available on GitHub at sbeaulieu/Pescadero/PescStats), to get a plot (barplot or scatterplot) and summary statistics of temperature data from a 10 minute interval near the end of chemical measurements. TempStats() relies on functions from the package lubridate. The functions in PescStats are frequently updated, so PescStats may need to be reinstalled on occasion. Variations on the functions sum_stats() and TempStats() are defined below as sum_stats_values() and TempStats_Times(), as wll as the two novel functions chem_measure() and ISS_Stats(). The purposes of these additional functions are commented where they are defined.

Note that in the current version of this notebook, chem_measure() must be run before TempStats() and TempStats_times() if one wants to automatically retrieve the timing and duration for temperature measurements based on chemical measurements. Both TempStats() and TempStats_times() can still take manually-input start time and duration values.

The majority of the functions utilized in this notebook, but especially chem_measure(), TempStats(), and TempStats_times() are built around the syntax utilized in the files they call, referencing things such as specific column headers. These files, as well as the current version of this R Notebook, may be found in the Google Drive. For ease of modification, the file names are assigned to variables in the r chunk {r variables called often}. This way, if the file is renamed, the name just be modified in this chunk, rather than having to modify every instance in which that file is called.

R Libraries:
```{r libaries}
#testing automated temp times
#install.packages("lubridate")  #install lubridate, if not already present on the machine
library(lubridate)#load Lubridate
library(devtools) #load devtools (only necessary if installing PescStats from GitHub)
install_github("sbeaulieu/Pescadero/PescStats") #installs PescStats; not a bad idea to frequently re-install due to ongoing modifications of the package
library(PescStats) #load PescStats
```

Local functions:
```{local functions}
sum_stats_values<-function(x){   #variation of sum_stats() function in PescStats to return JUST the summary statistic values indicated below; original sum_stats() function prints these values with labels in the R console
  decimal<-strsplit(as.character(x),"\\.")[[1]][2] 
  if(is.na(decimal))
    digits <- 1 #sets up for rounding to 1 decimal place if original data is whole numbers
  else
    digits<-nchar(decimal)+1 #sets up for rounding to 1 more decimal place than in original data
  mean<-round(mean(x, na.rm=T), digits=digits) #calculates mean of data, with NAs removed and rounding
  med<-round(median(x, na.rm=T), digits=digits) #calculates median of data, with NAs removed and rounding
  range<-round(max(x, na.rm=T)-min(x, na.rm=T), digits=digits) #calculates range of data, with NAs removed and rounding
  var<-round(var(x, na.rm=T), digits=digits) #calculates variance of data, with NAs removed and rounding
  sd<-round(sd(x, na.rm=T), digits=digits) #calculates standard devation of data, with NAs removed and rounding
  SEM<-round(SEM(x),digits=digits) #calculates standard error of the mean of data, with NAs removed and roundign
  ISS_summary<-c(mean,med,range,var,sd,SEM) #stores summary statistics
}

chem_measure<-function(x,y,z){ #catered to pulling chem data times from various versions of the same spreadsheet
  all_ISS<-read.csv(x) #x is file name of this iteration of the sheet
  this_ISS<-subset(all_ISS, all_ISS$Station==y) #y is station number (00#); subsets just the measurements from that station
  this_locale<-subset(this_ISS,this_ISS$location==z) #z is location (bullseye, away, excavated_bullseye); subsets the measurements from that location at the aforementioned station, so that chem_measure only has one set of times
      chem_start<-ymd_hms(this_locale$Chem_Data_Start_Text) #pulls start of chem measurement from chem_time, which is a variable holding the output of chem_measure
    chem_end<-ymd_hms(this_locale$Chem_Data_End_Text) #pulls end of chem measurement from chem_time
    interval<-interval(chem_start,chem_end)
    length<-time_length(interval,unit="minutes")
      if (length<10) #checks if length of chemical measurement is <10 minutes
       temp_start<-chem_start #if the chemical measurement is <10 minutes, the tempearature start is the same as the chemical
      else
        temp_start<-ymd_hms(chem_end)-minutes(10) #if the chemical measurement is 10+ minutes, the temperature start is 10min before chemical measurements end
      if (length<10) #checks if chem mesurement is <10 minutes
        duration<-length #sets duration to length of chemical measurement if it's <10min
      else
        duration<-10 #sets duration of temp to 10 minutes if chemical measurements 10+ minutes
    temp_start<<-temp_start #globally defines start time for temperature until next time chem_measure is run
    duration<<-duration #globally defines temperature duration until next time chem_measure is run
  start2<-as.character(this_locale$Chem_Data_Start_Text) #if not stored as character, when concatinating summary stats, temperature times, and chemical times together later, the chemical times are either appended or prefixed to every other variable rather than standing alone
  end2<-as.character(this_locale$Chem_Data_End_Text)
    chem_time<<-c(start2,end2) #stores start and end time of chemical data analyzed, as listed in spreadsheet
  }

TempStats_times<-function(x,t,d){  #variation of TempStats() function in PescStats that outputs just the times that TempStats() uses
  ISS<-read.csv(x) #x is actual temperature log
  ISS$time<-ymd_hms(ISS$time) #assumes timestamps in "time" column are in year month day hour minute second format; from lubridate package
  start<-ymd_hms(t) #t is the desired start time for temperature
  end<-ymd_hms(start)+minutes(d) #d is the durration of the measurement
  ISS_duration<<-subset(ISS, time>start & time<end) #defines duration globally, so ISS_duration can be used outside of the function; overwritten when running the function again with different variables
  start2<-paste(start) #have to paste start and end because otherwise, the data will be converted to the timezone of the machine when printed, or it will print a string of numbers that is, presumably, a representation of the time value rather than the actual value; something to do with lubridate maybe
  end2<-paste(end)
  t_timeframe<-c(start2,end2) #stores start and end time of temperature data analyzed)
}

ISS_Stats<-function(c,t,s){ #x is variable for whole ISS, c is variable for chemistry times, t is variable for temp times, s is for sum_stats
  x<-paste(t) #pastes temperature times because lubridate(?) is still doing *something* funky with times
  y<-paste(c) 
  x<-c(y,x,s) #creates vector of data for a given site, in this order: chemical data start, chemical data end, temp data start, temp data end, mean, median, range, variance, st. dev, SEM
}
```

```{r variables called often}
chemical_times_csv<-"Pescadero_Chemical_Timestamps_31May2018_modified.csv"
    #column headers have been renamed from initial file sent by Scott to remove spaces
    #additional columns have been added to put chemical times in format recognized by lubridate
    #rows where chemical start/end times have been manually removed from this spreadsheet; they caused issues with chem_measure
    
#temp_start is created for each location by chem_measure() based on the starting chemical time in chemical_times_csv
#duration is created for each location by chem_measure() based on the length of chemical measurements in chemical_times_csv, default is 10min
ISS001<-"temp_log_001.csv"
ISS002<-"temp_log_002.csv"
ISS003<-"temp_log_003.csv"
ISS004<-"temp_log_004.csv"
ISS005<-"temp_log_005.csv"
ISS006<-"temp_log_006.csv"
ISS007<-"temp_log_007.csv"
```
ISS 001
```{r 001}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,1,"bullseye") #get chem start and end times; chemical_times_csv defined in {r variables called often}
  t_timeframe<-TempStats_times(ISS001,temp_start,duration) #get temp start and end times
  ISS_summary<-sum_stats_values(ISS_duration$temperature) #get summary statistics
ISS1_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary) #creates vector of the times and summary statistics for ISS1 Bullseye

TempStats(ISS001,temp_start,duration,"ISS001 Bullseye", "scatterplot") #calculates summary statistics, temperature timeframe given temperature start time and duration (determined by chem_measure() or input manually), and produces plot (bar or scatter) of temperature

#50cm Away
  chem_time<-chem_measure(chemical_times_csv, 1,"away")
  t_timeframe<-TempStats_times(ISS001,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS1_away<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS001,temp_start,duration,"ISS1 0.50m Away from Bullseye","scatterplot")
```
ISS 002
```{r 002}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,2,"bullseye") 
  t_timeframe<-TempStats_times(ISS002,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS2_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS002,temp_start,duration,"ISS002 Bullseye", "scatterplot")

#50cm Away
  chem_time<-chem_measure(chemical_times_csv, 2,"away")
  t_timeframe<-TempStats_times(ISS002,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS2_away<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS002,temp_start,duration,"ISS2 0.50m Away from Bullseye","scatterplot")
```
ISS 003
```{r 003}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,3,"bullseye") 
  t_timeframe<-TempStats_times(ISS003,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS3_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS003,temp_start,duration,"ISS003 Bullseye", "scatterplot")

#50cm Away
  chem_time<-chem_measure(chemical_times_csv, 3,"away")
  t_timeframe<-TempStats_times(ISS003,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS3_away<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS003,temp_start,duration,"ISS3 0.50m Away from Bullseye","scatterplot")
```
ISS 004
```{r 004}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,4,"bullseye") 
  t_timeframe<-TempStats_times(ISS004,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS4_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS004,temp_start,duration,"ISS004 Bullseye", "scatterplot")

#50cm Away
  chem_time<-chem_measure(chemical_times_csv, 4,"away")
  t_timeframe<-TempStats_times(ISS004,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS4_away<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS004,temp_start,duration,"ISS4 0.50m Away from Bullseye","scatterplot")

#Bullseye Post Excavation
  chem_time<-chem_measure(chemical_times_csv, 4,"excavated_bullseye")
  t_timeframe<-TempStats_times(ISS004,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS4_bull_excavated<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS004,temp_start,duration,"ISS4 Excavated Bullseye","scatterplot")
```
ISS 005
```{r 005}
#Excavated Bullseye
  chem_time<-chem_measure(chemical_times_csv,5,"excavated_bullseye") 
  t_timeframe<-TempStats_times(ISS005,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS5_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS005,temp_start,duration,"ISS5 Excavated Bullseye", "scatterplot")

#50cm Away: no chemical data

#75cm Away
  chem_time<-chem_measure(chemical_times_csv, 5,"away")
  t_timeframe<-TempStats_times(ISS005,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS5_0.75m_away<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS005,temp_start,duration,"ISS5 0.75m Away from Bullseye","scatterplot")

```
ISS 006
```{r 006}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,6,"bullseye") 
  t_timeframe<-TempStats_times(ISS006,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS6_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS004,temp_start,duration,"ISS006 Bullseye", "scatterplot")

#Bullseye Post Excavation
  chem_time<-chem_measure(chemical_times_csv, 6,"excavated_bullseye")
  t_timeframe<-TempStats_times(ISS006,temp_start,duration)
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS6_bull_excavated<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS006,temp_start,duration,"ISS6 Excavated Bullseye","scatterplot")

```
ISS 007
```{r 007}
#Bullseye
  chem_time<-chem_measure(chemical_times_csv,7,"bullseye") 
  t_timeframe<-TempStats_times(ISS007,temp_start,duration) 
  ISS_summary<-sum_stats_values(ISS_duration$temperature)
ISS7_bullseye<-ISS_Stats(chem_time,t_timeframe,ISS_summary)

TempStats(ISS007,temp_start,duration,"ISS007 Bullseye", "scatterplot")

#50cm Away: no chemical data
```

Table of Times and Data
```{r}
all<-rbind(ISS1_bullseye,ISS1_away,ISS2_bullseye,ISS2_away,ISS3_bullseye,ISS3_away,ISS4_bullseye,ISS4_away,ISS4_bull_excavated,ISS5_bullseye,ISS5_0.75m_away,ISS6_bullseye,ISS6_bull_excavated,ISS7_bullseye) #builds matrix using all station-location vectors above
columns<-c("Chem Start","Chem End","Temp Start","Temp End","Mean","Median","Range","Variance","St. Dev.","St. Err. Mean") #order of data in ea. vector
colnames(all)<-columns #labels matrix

print(all)
print("Temperature data times from near last 10min of chemistry data. All times are UTC, and temperatures in degrees C.")

```